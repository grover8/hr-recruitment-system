<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HR Recruitment Dashboard</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#222}
  .container{max-width:1200px;margin:0 auto}
  .header{background:#fff;padding:18px;border-radius:12px;margin-bottom:18px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
  .header h1{font-size:24px}
  .tabs{display:flex;gap:12px;margin-bottom:18px;flex-wrap:wrap}
  .tab{background:#fff;padding:12px 18px;border-radius:10px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.06);font-weight:600;color:#444}
  .tab.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
  .content{background:#fff;padding:22px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);display:none}
  .content.active{display:block}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  label{display:block;margin-bottom:6px;font-weight:600;color:#333}
  input,textarea,select{width:100%;padding:10px;border:1px solid #e6e6e6;border-radius:8px;font-size:14px}
  button{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:700}
  .links{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .link-card{background:#f8f9fa;padding:14px;border-radius:8px;flex:1;min-width:220px;border:1px solid #e9e9e9;text-align:center}
  .results{margin-top:18px;display:grid;gap:14px}
  .candidate-card{background:#fff;border:1px solid #eee;border-radius:10px;padding:14px}
  .candidate-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .candidate-name{font-weight:700;font-size:16px}
  .skill-tag{display:inline-block;background:#e9f2ff;padding:6px 8px;border-radius:6px;margin:6px 6px 0 0;font-weight:600;font-size:12px;color:#0b5ed7}
  .stats{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
  .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:12px;border-radius:8px;min-width:160px;text-align:center}
  .small-muted{color:#666;font-size:13px}
  .message{padding:12px;border-radius:8px;margin-top:12px;display:none}
  .message.success{background:#e8f6ec;color:#155724;border:1px solid #c7e7cf}
  .message.error{background:#fbeaea;color:#7a1c1c;border:1px solid #f0c7c7}
  .export-btn{background:#28a745}
  @media(max-width:800px){.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ¯ HR Recruitment Dashboard</h1>
    <p class="small-muted">Manage job postings, review candidates, and search talent â€” all in one place.</p>
  </div>

  <div class="tabs" role="tablist" aria-label="Main Tabs">
    <div class="tab active" data-tab="search">ğŸ” Search Candidates</div>
    <div class="tab" data-tab="create-job">ğŸ“ Create Job Posting</div>
    <div class="tab" data-tab="links">ğŸ”— Application Forms</div>
    <div class="tab" data-tab="sheets">ğŸ“Š View All Data</div>
  </div>

  <!-- SEARCH -->
  <div id="search" class="content active" role="tabpanel">
    <h2 style="margin-bottom:12px">ğŸ” Search & Filter Candidates</h2>

    <form id="searchForm">
      <div class="row">
        <div>
          <label for="location">Location</label>
          <input id="location" name="location" placeholder="e.g., Mumbai, Delhi, Bangalore" />
        </div>
        <div>
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="">All Statuses</option>
            <option value="new">New</option>
            <option value="screening">Screening</option>
            <option value="interview">Interview</option>
            <option value="selected">Selected</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label for="min_experience">Minimum Experience (years)</label>
          <input id="min_experience" name="min_experience" type="number" min="0" value="0" />
        </div>
        <div>
          <label for="max_experience">Maximum Experience (years)</label>
          <input id="max_experience" name="max_experience" type="number" min="0" value="100" />
        </div>
      </div>

      <div style="margin-top:12px">
        <label for="skills">Skills (comma-separated)</label>
        <input id="skills" name="skills" placeholder="e.g., React, Python, Node.js" />
        <div style="margin-top:12px"><button type="submit">ğŸ” Search Candidates</button></div>
      </div>
    </form>

    <div id="searchMessage" class="message"></div>
    <div id="searchStats" class="stats" style="display:none">
      <div class="stat-card"><div style="font-size:18px;font-weight:700" id="totalCandidates">0</div><div style="opacity:.9">Total Candidates</div></div>
      <div class="stat-card"><div style="font-size:18px;font-weight:700" id="filteredCount">0</div><div style="opacity:.9">Matching Results</div></div>
    </div>

    <div style="margin-top:14px">
      <button id="exportAll" class="export-btn" style="display:none;margin-bottom:12px">ğŸ“¥ Export All Results to CSV</button>
    </div>

    <div id="searchResults" class="results"></div>
  </div>

  <!-- CREATE JOB -->
  <div id="create-job" class="content" role="tabpanel" aria-hidden="true">
    <h2 style="margin-bottom:12px">ğŸ“ Create New Job Posting</h2>
    <form id="jobForm">
      <div style="margin-bottom:12px">
        <label>Job Title *</label>
        <input name="job_title" required placeholder="e.g., Senior React Developer" />
      </div>
      <div style="margin-bottom:12px">
        <label>Job Description *</label>
        <textarea name="job_description" required placeholder="Describe the role..." rows="5"></textarea>
      </div>

      <div class="row">
        <div>
          <label>Location *</label>
          <input name="location" required placeholder="e.g., Mumbai" />
        </div>
        <div>
          <label>Department *</label>
          <input name="department" required placeholder="e.g., Engineering" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label>Minimum Experience (years) *</label>
          <input name="min_experience" type="number" min="0" value="0" required />
        </div>
        <div>
          <label>Maximum Age</label>
          <input name="max_age" type="number" min="18" value="100" />
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Salary Range</label>
        <input name="salary_range" placeholder="e.g., 15-20 LPA" />
      </div>

      <div style="margin-top:12px"><button type="submit">Create Job Posting</button></div>
      <div id="jobMessage" class="message" style="display:none"></div>
    </form>
  </div>

  <!-- LINKS -->
  <div id="links" class="content" role="tabpanel" aria-hidden="true">
    <h2 style="margin-bottom:12px">ğŸ”— Application Forms & Resources</h2>
    <div class="links">
      <div class="link-card">
        <h3>ğŸ“‹ Candidate Application Form</h3>
        <p class="small-muted">Share this link with candidates to apply</p>
        <a id="candidateFormLink" href="#" target="_blank" rel="noopener">Open Application Form â†’</a>
      </div>
      <div class="link-card">
        <h3>ğŸ“Š Google Sheets Dashboard</h3>
        <p class="small-muted">View and manage all data</p>
        <a href="#" id="jobsSheetLink" target="_blank" rel="noopener">Open Google Sheet â†’</a>
      </div>
      <div class="link-card">
        <h3>ğŸ“ Resume Storage</h3>
        <p class="small-muted">Access all uploaded resumes</p>
        <a href="#" id="driveFolderLink" target="_blank" rel="noopener">Open Drive Folder â†’</a>
      </div>
    </div>
    <div style="margin-top:14px;padding:12px;background:#fff3cd;border-radius:8px;border:1px solid #ffd27a">
      <h4>Quick Setup Guide</h4>
      <ol style="margin-left:18px;margin-top:8px">
        <li>Set webhook URLs in the script</li>
        <li>Share candidate application form link</li>
        <li>Use dashboard to search and create jobs</li>
        <li>Open Sheets for full data</li>
      </ol>
    </div>
  </div>

  <!-- SHEETS -->
  <div id="sheets" class="content" role="tabpanel" aria-hidden="true">
    <h2 style="margin-bottom:12px">ğŸ“Š Data Management</h2>
    <div class="stats" style="gap:16px">
      <div class="stat-card"><div style="font-size:18px">ğŸ“</div><div style="opacity:.95">Jobs Sheet</div><a id="viewJobs" href="#" target="_blank" style="color:#fff;display:block;margin-top:8px;text-decoration:underline">View Jobs â†’</a></div>
      <div class="stat-card"><div style="font-size:18px">ğŸ‘¥</div><div style="opacity:.95">Candidates Sheet</div><a id="viewCandidates" href="#" target="_blank" style="color:#fff;display:block;margin-top:8px;text-decoration:underline">View Candidates â†’</a></div>
    </div>
  </div>
</div>

<script>
/* ------------ CONFIG -------------- */
const WEBHOOKS = {
  createJob: 'https://n8n.srv1163004.hstgr.cloud/webhook/apply-job',          // update if needed
  searchCandidates: 'https://n8n.srv1163004.hstgr.cloud/webhook/search-candidates', // update if needed
  candidateForm: 'https://grover8.github.io/hr-recruitment-system/candidate_application_form.html',
  jobsSheet: 'https://docs.google.com/spreadsheets/d/12SY44opAnWer68CMicfZZz_lsn09G_hDPD2nXXr7lbk',
  driveFolder: 'https://drive.google.com/drive/folders/12SY44opAnWer68CMicfZZz_lsn09G_hDPD2nXXr7lbk'
};
/* ---------- UI Helpers ------------ */
function showTab(name){
  document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  const tabBtn = document.querySelector(`.tab[data-tab="${name}"]`);
  if(tabBtn) tabBtn.classList.add('active');
  const panel = document.getElementById(name);
  if(panel) panel.classList.add('active');
}
/* ---------- Render / util --------- */
function safeText(v){ return (v === undefined || v === null) ? '' : String(v); }
function createCandidateCard(cand){
  const skillsHTML = cand.skills ? cand.skills.split(',').slice(0,10).map(s=>`<span class="skill-tag">${s.trim()}</span>`).join('') : '';
  return `
    <div class="candidate-card">
      <div class="candidate-header">
        <div>
          <div class="candidate-name">${escapeHtml(cand.name||'N/A')}</div>
          <div class="small-muted">${escapeHtml(cand.current_role||'Not specified')} at ${escapeHtml(cand.current_company||'N/A')}</div>
        </div>
        <div style="background:#eef2ff;padding:6px 10px;border-radius:999px;font-weight:700;color:#254eda">${escapeHtml(cand.status||'New')}</div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px">
        <div><div class="small-muted">ğŸ“§ Email</div>${escapeHtml(cand.email||'N/A')}</div>
        <div><div class="small-muted">ğŸ“ Phone</div>${escapeHtml(cand.phone||'N/A')}</div>
        <div><div class="small-muted">ğŸ“ Location</div>${escapeHtml(cand.location||'N/A')}</div>
        <div><div class="small-muted">ğŸ’¼ Experience</div>${escapeHtml(cand.total_experience||0)} years</div>
        <div><div class="small-muted">ğŸ“ Education</div>${escapeHtml(cand.education||'N/A')}</div>
        <div><div class="small-muted">ğŸ“… Applied</div>${escapeHtml(cand.applied_date||'N/A')}</div>
      </div>
      ${skillsHTML ? `<div style="margin-top:12px"><div class="small-muted">ğŸ›  Skills</div>${skillsHTML}</div>` : ''}
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        ${(cand.resume_link) ? `<button onclick="window.open('${encodeURI(cand.resume_link)}','_blank')">ğŸ“„ View Resume</button>` : `<button disabled>No Resume</button>`}
        <button onclick="copyEmail('${escapeJs(cand.email||'')}')">ğŸ“‹ Copy Email</button>
      </div>
    </div>
  `;
}
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
}
function escapeJs(s){ return String(s||'').replace(/'/g,"\\'").replace(/\n/g,' '); }

/* ---------- CSV Export ---------- */
function exportToCSV(items, filename='candidates_export.csv'){
  const headers = ['Name','Email','Phone','Location','Experience','Company','Role','Skills','Education','Applied'];
  const rows = items.map(c=>[
    c.name||'',
    c.email||'',
    c.phone||'',
    c.location||'',
    c.total_experience||'',
    c.current_company||'',
    c.current_role||'',
    c.skills||'',
    c.education||'',
    c.applied_date||''
  ]);
  let csv = headers.join(',') + '\n' + rows.map(r=>r.map(cell=>`"${String(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ---------- Copy email --------- */
function copyEmail(email){
  if(!email){ alert('No email to copy'); return; }
  navigator.clipboard?.writeText(email).then(()=>alert('Email copied: '+email)).catch(()=>{ alert('Copy failed.'); });
}

/* ---------- STATE ---------- */
let lastSearchResults = [];

/* ---------- Event wiring ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  // tabs
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click',()=> showTab(btn.dataset.tab));
  });

  // set links
  document.getElementById('candidateFormLink').href = WEBHOOKS.candidateForm;
  document.getElementById('jobsSheetLink').href = WEBHOOKS.jobsSheet;
  document.getElementById('driveFolderLink').href = WEBHOOKS.driveFolder;
  document.getElementById('viewJobs').href = WEBHOOKS.jobsSheet;
  document.getElementById('viewCandidates').href = WEBHOOKS.jobsSheet;

  // search submit
  const sf = document.getElementById('searchForm');
  sf.addEventListener('submit', async (e) => {
    e.preventDefault();
    const messageEl = document.getElementById('searchMessage');
    const statsEl = document.getElementById('searchStats');
    const resultsEl = document.getElementById('searchResults');
    const exportAllBtn = document.getElementById('exportAll');
    messageEl.style.display = 'none'; statsEl.style.display = 'none'; resultsEl.innerHTML = ''; exportAllBtn.style.display = 'none';

    const payload = {
      location: sf.location.value || '',
      status: sf.status.value || '',
      min_experience: Number(sf.min_experience.value||0),
      max_experience: Number(sf.max_experience.value||100),
      skills: sf.skills.value || ''
    };

    try{
      const resp = await fetch(WEBHOOKS.searchCandidates, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!resp.ok) throw new Error('Search request failed: '+resp.status);
      const data = await resp.json();

      // Expecting format: { total_candidates, filtered_count, results: [...] }
      const results = data.results || [];
      lastSearchResults = results;

      if(results.length === 0){
        messageEl.className = 'message';
        messageEl.classList.add('error');
        messageEl.style.display = 'block';
        messageEl.textContent = 'No candidates found. Try adjusting your search criteria.';
      } else {
        statsEl.style.display = 'flex';
        document.getElementById('totalCandidates').textContent = data.total_candidates || results.length;
        document.getElementById('filteredCount').textContent = data.filtered_count || results.length;
        resultsEl.innerHTML = results.map(r=>createCandidateCard(r)).join('');
        exportAllBtn.style.display = 'inline-block';
      }
    }catch(err){
      messageEl.className = 'message';
      messageEl.classList.add('error');
      messageEl.style.display = 'block';
      messageEl.textContent = 'Search error: ' + (err.message||err);
      console.error(err);
    }
  });

  // export button
  document.getElementById('exportAll').addEventListener('click',()=> exportToCSV(lastSearchResults || []));

  // job form
  document.getElementById('jobForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fm = e.target;
    const msg = document.getElementById('jobMessage');
    msg.style.display = 'none';

    const payload = {
      job_title: fm.job_title.value,
      job_description: fm.job_description.value,
      location: fm.location.value,
      department: fm.department.value,
      min_experience: Number(fm.min_experience.value||0),
      max_age: Number(fm.max_age.value||100),
      salary_range: fm.salary_range.value || '',
    };

    try{
      const res = await fetch(WEBHOOKS.createJob, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('Job create failed: '+res.status);
      const json = await res.json();
      msg.className = 'message success'; msg.style.display='block';
      msg.textContent = json.message || 'Job created successfully';
      fm.reset();
    }catch(err){
      msg.className = 'message error'; msg.style.display='block';
      msg.textContent = 'Error creating job: ' + (err.message||err);
      console.error(err);
    }
  });

  // show initial
  showTab('search');
});

/* ---------- Small safety for older browsers ---------- */
(function polyfills(){
  if(!window.fetch){ console.warn('Fetch missing - page may not work in this browser'); }
})();
</script>
</body>
</html>
